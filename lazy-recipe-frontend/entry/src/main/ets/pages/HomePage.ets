import { ApiService } from '../common/ApiService';
import { Preferences } from '../model/Preferences';
import { IngredientsMap, IngredientCategory, SubIngredientCategory } from '../model/IngredientsMap';
import router from '@ohos.router';

@Entry
@Component
export struct HomePage {
  @State currentTab: number = 0;

  @State categoryList: IngredientCategory[] = [];
  @State tastes: string[] = [];
  @State styles: string[] = [];

  @State selectedIngredients: string[] = [];
  @State selectedTaste: string = '';
  @State selectedStyle: string = '';

  @State expandedCategories: Set<string> = new Set();
  @State expandedSubcategories: Set<string> = new Set();

  private categoryDisplayMap: Record<string, string> = {
    'MEAT': 'ğŸ¥© è‚‰ç±»',
    'VEGETABLE': 'ğŸ¥¬ è”¬èœ',
    'STAPLE': 'ğŸš ä¸»é£Ÿ',
    'SEAFOOD': 'ğŸ¦ æ°´äº§',
    'EGG_DAIRY': 'ğŸ¥š è›‹å¥¶',
    'BEAN_PRODUCT': 'ğŸ«˜ è±†åˆ¶å“'
  };

  private subCategoryDisplay: Record<string, string> = {
    // ä¸»é£Ÿ
    "ç±³ç±»": "ğŸš ç±³ç±»",
    "é¢ç±»": "ğŸœ é¢ç±»",
    "æ‚ç²®": "ğŸŒ¾ æ‚ç²®",

    // è”¬èœ
    "å¶èœç±»": "ğŸ¥¬ å¶èœç±»",
    "æ ¹èŒç±»": "ğŸ¥• æ ¹èŒç±»",
    "èŒ„ç“œç±»": "ğŸ† èŒ„ç“œç±»",
    "è‘±å§œè’œç±»": "ğŸ§„ è‘±å§œè’œç±»",
    "è±†ç±»è”¬èœ": "ğŸ«˜ è±†ç±»è”¬èœ",
    "èŒè‡ç±»": "ğŸ„ èŒè‡ç±»",

    // è‚‰ç±»
    "çŒªè‚‰": "ğŸ– çŒªè‚‰",
    "ç‰›è‚‰": "ğŸ„ ç‰›è‚‰",
    "ç¾Šè‚‰": "ğŸ ç¾Šè‚‰",
    "é¸¡è‚‰": "ğŸ” é¸¡è‚‰",
    "é¸­è‚‰": "ğŸ¦† é¸­è‚‰",

    // æ°´äº§
    "é±¼ç±»": "ğŸŸ é±¼ç±»",
    "è™¾èŸ¹è´": "ğŸ¦ è™¾èŸ¹è´",
    "å…¶ä»–": "ğŸŒŠ å…¶ä»–",

    // è›‹å¥¶
    "è›‹ç±»": "ğŸ¥š è›‹ç±»",
    "ä¹³ç±»": "ğŸ¥› ä¹³ç±»",

    // è±†åˆ¶å“
    "è±†ç±»": "ğŸŒ° è±†ç±»",
    "åˆ¶å“": "ğŸ§ˆ åˆ¶å“"
  };


  private tasteDisplay: Record<string, string> = {
    "æ¸…æ·¡": "ğŸ¥— æ¸…æ·¡",
    "å’¸é¦™": "ğŸ§‚ å’¸é¦™",
    "å¾®è¾£": "ğŸŒ¶ï¸ å¾®è¾£",
    "é‡è¾£": "ğŸ”¥ é‡è¾£",
    "é…¸ç”œ": "ğŸ¬ é…¸ç”œ",
    "é¦™è¾£": "ğŸ«šğŸŒ¶ï¸ é¦™è¾£",
    "éº»è¾£": "ğŸ«‘ğŸŒ¶ï¸ éº»è¾£",
    "é²œé¦™": "ğŸ² é²œé¦™"
  };


  private styleDisplay: Record<string, string> = {
    "å®¶å¸¸èœ": "ğŸ¡ å®¶å¸¸èœ",
    "å¿«æ‰‹èœ": "âš¡ å¿«æ‰‹èœ",
    "å¥åº·å‡è„‚": "ğŸ¥¦ å¥åº·å‡è„‚",
    "å·èœ": "ğŸŒ¶ï¸ å·èœ",
    "ç²¤èœ": "ğŸ› ç²¤èœ",
    "æ¹˜èœ": "ğŸŒ¶ï¸ æ¹˜èœ",
    "ä¸œåŒ—èœ": "â„ï¸ ä¸œåŒ—èœ",
    "è¥¿åŒ—èœ": "ğŸ¦´ è¥¿åŒ—èœ",
    "æœ¬å¸®èœ": "ğŸœ æœ¬å¸®èœ",
    "æ—¥å¼æ–™ç†": "ğŸ± æ—¥å¼æ–™ç†",
    "éŸ©å¼æ–™ç†": "ğŸ² éŸ©å¼æ–™ç†"
  };


  async aboutToAppear() {
    const rawMap: IngredientsMap = await ApiService.getIngredients();

    this.categoryList = Object.keys(rawMap).map((key: string): IngredientCategory => {
      return {
        category: key,
        subcategories: rawMap[key]
      };
    });

    const prefs: Preferences = await ApiService.getPreferences();
    this.tastes = prefs.tastes;
    this.styles = prefs.styles;
  }

  toggleCategory(category: string) {
    const newSet = new Set(this.expandedCategories);
    newSet.has(category) ? newSet.delete(category) : newSet.add(category);
    this.expandedCategories = newSet;
  }

  toggleSubcategory(subcategoryKey: string) {
    const newSet = new Set(this.expandedSubcategories);
    newSet.has(subcategoryKey) ? newSet.delete(subcategoryKey) : newSet.add(subcategoryKey);
    this.expandedSubcategories = newSet;
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Column() {
          Text('æ‡’äººé£Ÿè°±åŠ©æ‰‹')
            .fontSize(36)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
          Text('å‘ç°ç¾é£Ÿï¼Œäº«å—ç”Ÿæ´»')
            .fontSize(14)
            .fontColor('#999999')
            .margin({ top: 4 })
        }
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 20, bottom: 16 })
      .backgroundColor('#FFFFFF')
      .shadow({ radius: 8, color: '#08000000', offsetY: 2 })

      Scroll() {
        Column() {
          // é€‰æ‹©é£Ÿææ ‡é¢˜
          Row() {
            Text('ğŸ“¦ é€‰æ‹©é£Ÿæ')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')

            if (this.selectedIngredients.length > 0) {
              Text(`å·²é€‰ ${this.selectedIngredients.length} é¡¹`)
                .fontSize(14)
                .fontColor('#FF6B6B')
                .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                .backgroundColor('#FFE5E5')
                .borderRadius(12)
                .margin({ left: 12 })
            }
          }
          .width('100%')
          .margin({ top: 20, bottom: 12 })

          // é£Ÿæåˆ†ç±»
          ForEach(this.categoryList, (catItem: IngredientCategory) => {
            Column() {
              // å¤§ç±»æ ‡é¢˜
              Row() {
                Text(this.expandedCategories.has(catItem.category) ? 'â–¼' : 'â–¶')
                  .fontSize(16)
                  .fontColor('#666666')
                  .margin({ right: 10 })

                Text(this.categoryDisplayMap[catItem.category] ?? catItem.category)
                  .fontSize(18)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#333333')
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#FFFFFF')
              .borderRadius(12)
              .margin({ bottom: 8 })
              .shadow({ radius: 4, color: '#08000000', offsetY: 2 })
              .onClick(() => this.toggleCategory(catItem.category))

              // å­ç±»åˆ—è¡¨
              if (this.expandedCategories.has(catItem.category)) {
                Column() {
                  ForEach(catItem.subcategories, (subcat: SubIngredientCategory) => {
                    Column() {
                      // å­ç±»æ ‡é¢˜
                      Row() {
                        Text(this.expandedSubcategories.has(`${catItem.category}-${subcat.subcategory}`) ? 'â–¼' : 'â–¶')
                          .fontSize(14)
                          .fontColor('#999999')
                          .margin({ right: 8 })

                        Text(this.subCategoryDisplay[subcat.subcategory] ?? subcat.subcategory)
                          .fontSize(16)
                          .fontColor('#666666')
                      }
                      .width('100%')
                      .padding({ left: 32, top: 12, bottom: 12, right: 16 })
                      .backgroundColor('#F8F9FA')
                      .borderRadius(8)
                      .margin({ top: 4 })
                      .onClick(() => this.toggleSubcategory(`${catItem.category}-${subcat.subcategory}`))

                      // é£Ÿæåˆ—è¡¨
                      if (this.expandedSubcategories.has(`${catItem.category}-${subcat.subcategory}`)) {
                        Column() {
                          ForEach(subcat.ingredients, (item: string) => {
                            Row() {
                              Checkbox()
                                .select(this.selectedIngredients.includes(item))
                                .selectedColor('#FF6B6B')
                                .onChange((value: boolean) => {
                                  if (value) {
                                    this.selectedIngredients.push(item);
                                  } else {
                                    this.selectedIngredients = this.selectedIngredients.filter(i => i !== item);
                                  }
                                })

                              Text(item)
                                .fontSize(15)
                                .fontColor('#333333')
                                .margin({ left: 12 })
                            }
                            .width('100%')
                            .padding({ left: 52, top: 8, bottom: 8, right: 16 })
                          })
                        }
                        .width('100%')
                        .backgroundColor('#FAFBFC')
                        .borderRadius(8)
                        .margin({ top: 4, left: 16, right: 4 })
                      }
                    }
                    .width('100%')
                  })
                }
                .width('100%')
                .margin({ bottom: 8 })
              }
            }
            .width('100%')
          })

          // æ˜¾ç¤ºå·²é€‰é£Ÿæ
          if (this.selectedIngredients.length > 0) {
            Text('ğŸ§º å·²é€‰é£Ÿæ')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .margin({ top: 16, bottom: 8 })

            Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
              ForEach(this.selectedIngredients, (item: string) => {
                Text(item)
                  .fontSize(15)
                  .fontColor('#555555')
                  .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                  .backgroundColor('#EFEFEF')
                  .borderRadius(16)
                  .margin({ right: 8, bottom: 8 })
              })
            }
          }


          // å£å‘³é€‰æ‹©ï¼ˆå·²æ”¹ä¸º Flexï¼‰
          Text('ğŸŒ¶ï¸ é€‰æ‹©å£å‘³')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .width('100%')
            .margin({ top: 32, bottom: 12 })

          Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
            ForEach(this.tastes, (t: string) => {
              Text(this.tasteDisplay[t] ?? t)
                .fontSize(16)
                .fontColor(this.selectedTaste === t ? '#FFFFFF' : '#666666')
                .padding({ left: 20, right: 20, top: 10, bottom: 10 })
                .backgroundColor(this.selectedTaste === t ? '#FF6B6B' : '#FFFFFF')
                .borderRadius(20)
                .border({ width: 1, color: this.selectedTaste === t ? '#FF6B6B' : '#DDDDDD' })
                .margin({ right: 8, bottom: 8 })
                .onClick(() => {
                  this.selectedTaste = this.selectedTaste === t ? '' : t;
                })
            })
          }
          .width('100%')

          // èœç³»é€‰æ‹©ï¼ˆå·²æ”¹ä¸º Flexï¼‰
          Text('ğŸ¥˜ é€‰æ‹©èœç³»')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .width('100%')
            .margin({ top: 24, bottom: 12 })

          Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
            ForEach(this.styles, (s: string) => {
              Text(this.styleDisplay[s] ?? s)
                .fontSize(16)
                .fontColor(this.selectedStyle === s ? '#FFFFFF' : '#666666')
                .padding({ left: 20, right: 20, top: 10, bottom: 10 })
                .backgroundColor(this.selectedStyle === s ? '#4ECDC4' : '#FFFFFF')
                .borderRadius(20)
                .border({ width: 1, color: this.selectedStyle === s ? '#4ECDC4' : '#DDDDDD' })
                .margin({ right: 8, bottom: 8 })
                .onClick(() => {
                  this.selectedStyle = this.selectedStyle === s ? '' : s;
                })
            })
          }
          .width('100%')

          // å¼€å§‹æ¨èæŒ‰é’®
          Button('å¼€å§‹æ¨èèœè°± ğŸ”')
            .width('100%')
            .height(50)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .backgroundColor('#FF6B6B')
            .borderRadius(25)
            .margin({ top: 32, bottom: 32 })
            .onClick(() => {
              router.pushUrl({
                url: 'pages/RecommendPage',
                params: {
                  ingredients: this.selectedIngredients,
                  taste: this.selectedTaste,
                  style: this.selectedStyle
                }
              });
            })
        }
        .width('100%')
        .padding({ left: 20, right: 20 })
      }
      .layoutWeight(1)
      .scrollBar(BarState.Auto)

      // åº•éƒ¨å¯¼èˆªæ 
      Row() {
        // é¦–é¡µ
        Column() {
          Text('â­•')
            .fontSize(24)
          Text('é¦–é¡µ')
            .fontSize(12)
        }
        .alignItems(HorizontalAlign.Center)
        .layoutWeight(1)
        .onClick(() => {
          this.currentTab = 0
        })

        // æ”¶è—å¤¹
        Column() {
          Text('â¤ï¸')
            .fontSize(24)
          Text('æ”¶è—')
            .fontSize(12)
        }
        .alignItems(HorizontalAlign.Center)
        .layoutWeight(1)
        .onClick(() => {
          this.currentTab = 1
          router.pushUrl({ url: 'pages/FavoritesPage' })
        })

        // å†å²è®°å½•
        Column() {
          Text('ğŸ•’')
            .fontSize(24)
          Text('å†å²')
            .fontSize(12)
        }
        .alignItems(HorizontalAlign.Center)
        .layoutWeight(1)
        .onClick(() => {
          this.currentTab = 2
          router.pushUrl({ url: 'pages/HistoryPage' })
        })
      }
      .width('100%')
      .height(60)
      .backgroundColor('#FFFFFF')
      .shadow({ radius: 8, color: '#08000000', offsetY: -2 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F9FA')
  }
}