import { ApiService } from '../common/ApiService';
import { Preferences } from '../model/Preferences';
import { IngredientsMap, IngredientCategory, SubIngredientCategory } from '../model/IngredientsMap';
import router from '@ohos.router';

@Entry
@Component
export struct HomePage {
  @State categoryList: IngredientCategory[] = [];
  @State tastes: string[] = [];
  @State styles: string[] = [];

  @State selectedIngredients: string[] = [];
  @State selectedTaste: string = '';
  @State selectedStyle: string = '';

  @State expandedCategories: Set<string> = new Set();
  @State expandedSubcategories: Set<string> = new Set();

  private categoryDisplayMap: Record<string, string> = {
    'MEAT': 'ðŸ¥© è‚‰ç±»',
    'VEGETABLE': 'ðŸ¥¬ è”¬èœ',
    'STAPLE': 'ðŸš ä¸»é£Ÿ',
    'SEAFOOD': 'ðŸ¦ æ°´äº§',
    'EGG_DAIRY': 'ðŸ¥š è›‹å¥¶',
    'BEAN_PRODUCT': 'ðŸ«˜ è±†åˆ¶å“'
  };

  async aboutToAppear() {
    const rawMap: IngredientsMap = await ApiService.getIngredients();

    this.categoryList = Object.keys(rawMap).map((key: string): IngredientCategory => {
      return {
        category: key,
        subcategories: rawMap[key]
      };
    });

    const prefs: Preferences = await ApiService.getPreferences();
    this.tastes = prefs.tastes;
    this.styles = prefs.styles;
  }

  toggleCategory(category: string) {
    const newSet = new Set(this.expandedCategories);
    newSet.has(category) ? newSet.delete(category) : newSet.add(category);
    this.expandedCategories = newSet;
  }

  toggleSubcategory(subcategoryKey: string) {
    const newSet = new Set(this.expandedSubcategories);
    newSet.has(subcategoryKey) ? newSet.delete(subcategoryKey) : newSet.add(subcategoryKey);
    this.expandedSubcategories = newSet;
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Column() {
          Text('æ‡’äººé£Ÿè°±åŠ©æ‰‹')
            .fontSize(36)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
          Text('å‘çŽ°ç¾Žé£Ÿï¼Œäº«å—ç”Ÿæ´»')
            .fontSize(14)
            .fontColor('#999999')
            .margin({ top: 4 })
        }
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 20, bottom: 16 })
      .backgroundColor('#FFFFFF')
      .shadow({ radius: 8, color: '#08000000', offsetY: 2 })

      Scroll() {
        Column() {
          // é€‰æ‹©é£Ÿææ ‡é¢˜
          Row() {
            Text('ðŸ“¦ é€‰æ‹©é£Ÿæ')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')

            if (this.selectedIngredients.length > 0) {
              Text(`å·²é€‰ ${this.selectedIngredients.length} é¡¹`)
                .fontSize(14)
                .fontColor('#FF6B6B')
                .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                .backgroundColor('#FFE5E5')
                .borderRadius(12)
                .margin({ left: 12 })
            }
          }
          .width('100%')
          .margin({ top: 20, bottom: 12 })

          // é£Ÿæåˆ†ç±»
          ForEach(this.categoryList, (catItem: IngredientCategory) => {
            Column() {
              // å¤§ç±»æ ‡é¢˜
              Row() {
                Text(this.expandedCategories.has(catItem.category) ? 'â–¼' : 'â–¶')
                  .fontSize(16)
                  .fontColor('#666666')
                  .margin({ right: 10 })

                Text(this.categoryDisplayMap[catItem.category] ?? catItem.category)
                  .fontSize(18)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#333333')
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#FFFFFF')
              .borderRadius(12)
              .margin({ bottom: 8 })
              .shadow({ radius: 4, color: '#08000000', offsetY: 2 })
              .onClick(() => this.toggleCategory(catItem.category))

              // å­ç±»åˆ—è¡¨
              if (this.expandedCategories.has(catItem.category)) {
                Column() {
                  ForEach(catItem.subcategories, (subcat: SubIngredientCategory) => {
                    Column() {
                      // å­ç±»æ ‡é¢˜
                      Row() {
                        Text(this.expandedSubcategories.has(`${catItem.category}-${subcat.subcategory}`) ? 'â–¼' : 'â–¶')
                          .fontSize(14)
                          .fontColor('#999999')
                          .margin({ right: 8 })

                        Text(subcat.subcategory)
                          .fontSize(16)
                          .fontColor('#666666')
                      }
                      .width('100%')
                      .padding({ left: 32, top: 12, bottom: 12, right: 16 })
                      .backgroundColor('#F8F9FA')
                      .borderRadius(8)
                      .margin({ top: 4 })
                      .onClick(() => this.toggleSubcategory(`${catItem.category}-${subcat.subcategory}`))

                      // é£Ÿæåˆ—è¡¨
                      if (this.expandedSubcategories.has(`${catItem.category}-${subcat.subcategory}`)) {
                        Column() {
                          ForEach(subcat.ingredients, (item: string) => {
                            Row() {
                              Checkbox()
                                .select(this.selectedIngredients.includes(item))
                                .selectedColor('#FF6B6B')
                                .onChange((value: boolean) => {
                                  if (value) {
                                    this.selectedIngredients.push(item);
                                  } else {
                                    this.selectedIngredients = this.selectedIngredients.filter(i => i !== item);
                                  }
                                })

                              Text(item)
                                .fontSize(15)
                                .fontColor('#333333')
                                .margin({ left: 12 })
                            }
                            .width('100%')
                            .padding({ left: 52, top: 8, bottom: 8, right: 16 })
                          })
                        }
                        .width('100%')
                        .backgroundColor('#FAFBFC')
                        .borderRadius(8)
                        .margin({ top: 4, left: 16, right: 4 })
                      }
                    }
                    .width('100%')
                  })
                }
                .width('100%')
                .margin({ bottom: 8 })
              }
            }
            .width('100%')
          })

          // å£å‘³é€‰æ‹©ï¼ˆå·²æ”¹ä¸º Flexï¼‰
          Text('ðŸŒ¶ï¸ é€‰æ‹©å£å‘³')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .width('100%')
            .margin({ top: 32, bottom: 12 })

          Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
            ForEach(this.tastes, (t: string) => {
              Text(t)
                .fontSize(16)
                .fontColor(this.selectedTaste === t ? '#FFFFFF' : '#666666')
                .padding({ left: 20, right: 20, top: 10, bottom: 10 })
                .backgroundColor(this.selectedTaste === t ? '#FF6B6B' : '#FFFFFF')
                .borderRadius(20)
                .border({ width: 1, color: this.selectedTaste === t ? '#FF6B6B' : '#DDDDDD' })
                .margin({ right: 8, bottom: 8 })
                .onClick(() => {
                  this.selectedTaste = this.selectedTaste === t ? '' : t;
                })
            })
          }
          .width('100%')

          // èœç³»é€‰æ‹©ï¼ˆå·²æ”¹ä¸º Flexï¼‰
          Text('ðŸ¥˜ é€‰æ‹©èœç³»')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .width('100%')
            .margin({ top: 24, bottom: 12 })

          Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
            ForEach(this.styles, (s: string) => {
              Text(s)
                .fontSize(16)
                .fontColor(this.selectedStyle === s ? '#FFFFFF' : '#666666')
                .padding({ left: 20, right: 20, top: 10, bottom: 10 })
                .backgroundColor(this.selectedStyle === s ? '#4ECDC4' : '#FFFFFF')
                .borderRadius(20)
                .border({ width: 1, color: this.selectedStyle === s ? '#4ECDC4' : '#DDDDDD' })
                .margin({ right: 8, bottom: 8 })
                .onClick(() => {
                  this.selectedStyle = this.selectedStyle === s ? '' : s;
                })
            })
          }
          .width('100%')

          // å¼€å§‹æŽ¨èæŒ‰é’®
          Button('å¼€å§‹æŽ¨èèœè°± ðŸ”')
            .width('100%')
            .height(50)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .backgroundColor('#FF6B6B')
            .borderRadius(25)
            .margin({ top: 32, bottom: 32 })
            .onClick(() => {
              router.pushUrl({
                url: 'pages/RecommendPage',
                params: {
                  ingredients: this.selectedIngredients,
                  taste: this.selectedTaste,
                  style: this.selectedStyle
                }
              });
            })
        }
        .width('100%')
        .padding({ left: 20, right: 20 })
      }
      .layoutWeight(1)
      .scrollBar(BarState.Auto)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F9FA')
  }
}