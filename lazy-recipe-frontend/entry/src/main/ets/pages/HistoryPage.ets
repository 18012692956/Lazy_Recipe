import { Recipe } from '../model/Recipe'
import { ApiService } from '../common/ApiService'
import router from '@ohos.router'
import promptAction from '@ohos.promptAction'

@Entry
@Component
export struct HistoryPage {
  @State recipes: Recipe[] = []
  @State isLoading: boolean = false

  aboutToAppear() {
    this.loadHistory()
  }

  private async loadHistory() {
    this.isLoading = true
    try {
      const data = await ApiService.getHistory()
      this.recipes = data
    } catch (e) {
      console.error('åŠ è½½å†å²è®°å½•å¤±è´¥', e)
    } finally {
      this.isLoading = false
    }
  }

  private async toggleFavorite(recipeId: number) {
    const currentRecipe = this.recipes.find(r => r.id === recipeId);
    if (!currentRecipe) return;

    try {
      const newFavoriteState = !currentRecipe.favorite;
      const updatedRecipes: Recipe[] = this.recipes.map((r: Recipe): Recipe => {
        if (r.id === recipeId) {
          return {
            id: r.id,
            title: r.title,
            ingredients: r.ingredients,
            taste: r.taste,
            style: r.style,
            timeMinutes: r.timeMinutes,
            difficulty: r.difficulty,
            steps: r.steps,
            favorite: newFavoriteState,
            lastViewedAt: r.lastViewedAt
          };
        }
        return r;
      });
      this.recipes = updatedRecipes;

      await ApiService.updateFavorite(recipeId);

    } catch (error) {
      console.error('æ›´æ–°æ”¶è—å¤±è´¥:', error);

      const rollbackRecipes: Recipe[] = this.recipes.map((r: Recipe): Recipe => {
        if (r.id === recipeId) {
          return {
            id: r.id,
            title: r.title,
            ingredients: r.ingredients,
            taste: r.taste,
            style: r.style,
            timeMinutes: r.timeMinutes,
            difficulty: r.difficulty,
            steps: r.steps,
            favorite: currentRecipe.favorite,
            lastViewedAt: r.lastViewedAt
          };
        }
        return r;
      });
      this.recipes = rollbackRecipes;
    }
  }

  // âœ… æ¸…ç©ºå†å²è®°å½•
  private async clearAllHistory() {
    if (this.recipes.length === 0) {
      promptAction.showToast({
        message: 'å†å²è®°å½•å·²ç»æ˜¯ç©ºçš„äº†',
        duration: 2000
      });
      return;
    }

    // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    AlertDialog.show({
      title: 'æ¸…ç©ºå†å²è®°å½•',
      message: `ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ ${this.recipes.length} æ¡æµè§ˆè®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,
      primaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {
          console.log('å–æ¶ˆæ¸…ç©º');
        }
      },
      secondaryButton: {
        value: 'ç¡®å®šæ¸…ç©º',
        fontColor: '#4ECDC4',
        action: async () => {
          await this.performClearAll();
        }
      }
    });
  }

  // æ‰§è¡Œæ¸…ç©ºæ“ä½œ
  private async performClearAll() {
    const backupRecipes = [...this.recipes];

    try {
      // ä¹è§‚æ›´æ–°ï¼šç«‹å³æ¸…ç©ºåˆ—è¡¨
      this.recipes = [];

      // è°ƒç”¨åç«¯ API æ¸…ç©ºå†å²
      await ApiService.clearHistory();

      promptAction.showToast({
        message: 'å·²æ¸…ç©ºå†å²è®°å½•',
        duration: 2000
      });

    } catch (error) {
      console.error('æ¸…ç©ºå†å²å¤±è´¥:', error);

      // å¤±è´¥æ—¶æ¢å¤
      this.recipes = backupRecipes;

      promptAction.showToast({
        message: 'æ¸…ç©ºå¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    }
  }

  private navigateToDetail(recipe: Recipe) {
    router.pushUrl({
      url: 'pages/DetailPage',
      params: recipe
    })
  }

  private formatTime(dateStr: string): string {
    if (!dateStr) return '';

    try {
      // è§£ææ—¥æœŸå­—ç¬¦ä¸²
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now.getTime() - date.getTime();

      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (minutes < 1) return 'åˆšåˆš';
      if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
      if (hours < 24) return `${hours}å°æ—¶å‰`;
      if (days < 7) return `${days}å¤©å‰`;

      // è¶…è¿‡7å¤©æ˜¾ç¤ºå…·ä½“æ—¥æœŸ
      const month = date.getMonth() + 1;
      const day = date.getDate();
      return `${month}æœˆ${day}æ—¥`;
    } catch (e) {
      return '';
    }
  }

  @Builder
  buildRecipeCard(r: Recipe) {
    Column() {
      Row() {
        Column() {
          Text(r.title)
            .fontSize(22)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          Row() {
            Text(`éš¾åº¦ï¼š${r.difficulty}`)
              .fontSize(15)
              .fontColor('#666666')

            Text('|')
              .fontSize(15)
              .fontColor('#DDDDDD')
              .margin({ left: 8, right: 8 })

            Text(`${r.timeMinutes}åˆ†é’Ÿ`)
              .fontSize(15)
              .fontColor('#666666')
          }.margin({ top: 8 })

          Row() {
            if (r.taste && r.taste !== '') {
              Text(r.taste)
                .fontSize(12)
                .fontColor('#FF6B6B')
                .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                .backgroundColor('#FFE5E5')
                .borderRadius(4)
            }
            if (r.style && r.style !== '') {
              Text(r.style)
                .fontSize(12)
                .fontColor('#4ECDC4')
                .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                .backgroundColor('#E5F9F7')
                .borderRadius(4)
                .margin({ left: 6 })
            }

            // æ˜¾ç¤ºæµè§ˆæ—¶é—´
            if (r.lastViewedAt) {
              Text(`ğŸ• ${this.formatTime(r.lastViewedAt)}`)
                .fontSize(12)
                .fontColor('#999999')
                .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                .backgroundColor('#F5F5F5')
                .borderRadius(4)
                .margin({ left: 6 })
            }
          }.margin({ top: 8 })
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
        .onClick(() => this.navigateToDetail(r))

        Column() {
          Text(r.favorite ? "â¤ï¸" : "ğŸ¤")
            .fontSize(24)
          Text(r.favorite ? "å·²æ”¶è—" : "æ”¶è—")
            .fontSize(13)
            .margin({ top: 4 })
            .fontColor(r.favorite ? '#FF6B6B' : '#999999')
        }
        .justifyContent(FlexAlign.Center)
        .padding({ left: 16, right: 8 })
        .onClick(() => {
          this.toggleFavorite(r.id);
        })
      }
      .width('100%')
      .padding(20)
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .margin({ bottom: 16 })
    .shadow({ radius: 12, color: '#15000000', offsetX: 0, offsetY: 4 })
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ 
      Row() {
        Row() {
          Text('â†')
            .fontSize(24)
            .fontColor('#666666')
          Text('è¿”å›')
            .fontSize(16)
            .fontColor('#666666')
            .margin({ left: 4 })
        }
        .onClick(() => router.back())

        Blank()

        Text('æµè§ˆå†å²')
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')

        Blank()

        // âœ… æ¸…ç©ºæŒ‰é’®
        Row() {
          Text('ğŸ—‘ï¸')
            .fontSize(20)
          Text('æ¸…ç©º')
            .fontSize(14)
            .fontColor('#999999')
            .margin({ left: 4 })
        }
        .padding({ left: 12, right: 12, top: 8, bottom: 8 })
        .backgroundColor(this.recipes.length > 0 ? '#E5F9F7' : '#F5F5F5')
        .borderRadius(16)
        .onClick(() => {
          this.clearAllHistory();
        })
      }
      .width('100%')
      .height(56)
      .padding({ left: 20, right: 20 })
      .backgroundColor('#FFFFFF')
      .shadow({ radius: 8, color: '#08000000', offsetX: 0, offsetY: 2 })

      // å†…å®¹åŒº
      if (this.isLoading) {
        Column() {
          Text("â³")
            .fontSize(48)
          Text("æ­£åœ¨åŠ è½½æµè§ˆå†å²...")
            .fontSize(16)
            .fontColor('#999999')
            .margin({ top: 16 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else if (this.recipes.length === 0) {
        Column() {
          Text("ğŸ“œ")
            .fontSize(64)
          Text("æš‚æ— æµè§ˆè®°å½•")
            .fontSize(18)
            .fontColor('#999999')
            .margin({ top: 16 })
          Text("å¿«å»çœ‹çœ‹æœ‰ä»€ä¹ˆå¥½åƒçš„å§ï½")
            .fontSize(14)
            .fontColor('#CCCCCC')
            .margin({ top: 8 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else {
        Column() {
          // ç»Ÿè®¡ä¿¡æ¯
          Row() {
            Text(`æœ€è¿‘æµè§ˆäº† `)
              .fontSize(15)
              .fontColor('#666666')
            Text(`${this.recipes.length}`)
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#4ECDC4')
            Text(` é“èœè°±`)
              .fontSize(15)
              .fontColor('#666666')
          }
          .width('100%')
          .padding({ left: 20, right: 20, top: 16, bottom: 8 })

          // èœè°±åˆ—è¡¨
          Scroll() {
            Column() {
              ForEach(this.recipes, (r: Recipe, i: number) => {
                Column() {
                  this.buildRecipeCard(r)
                }
              }, (r: Recipe, i: number) => `${i}-${r.id}-${r.favorite}`)
            }
            .width('100%')
            .padding({ left: 20, right: 20, bottom: 20 })
          }
          .layoutWeight(1)
          .scrollBar(BarState.Auto)
          .align(Alignment.Top)
        }
        .layoutWeight(1)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F9FA')
  }
}